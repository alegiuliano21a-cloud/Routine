<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Routine Mattutina â€” Diario Giornaliero</title>
<style>
  :root{ --bg:#f5f5f7; --fg:#1d1d1f; --card:#fff; --muted:#666; --accent:#0a84ff; --ok:#0a0; --bad:#d00; --shadow:0 6px 18px rgba(0,0,0,0.08); }
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg);margin:0;padding:16px;}
  h1{font-size:1.6rem;margin:0 0 12px;} h2{font-size:1.2rem;margin:0 0 10px;}
  .muted{color:var(--muted);} .small{font-size:.9rem;} .screen{display:none;} .screen.active{display:block;}
  .card{background:var(--card);border-radius:14px;padding:12px;box-shadow:var(--shadow);}
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
  .row{display:flex;gap:8px;flex-wrap:wrap;}
  button{background:#000;color:#fff;border:none;border-radius:10px;padding:12px 14px;font-size:1rem;cursor:pointer}
  button.secondary{background:#fff;color:#000;border:1px solid #ccc}
  fieldset{background:var(--card);border:none;border-radius:12px;padding:12px;margin:10px 0;box-shadow:var(--shadow);}
  legend{font-weight:700;}
  label{display:block;margin:8px 0 6px;}
  input[type="text"], input[type="number"], input[type="time"], input[type="date"], select, textarea{
    width:100%;padding:10px;border-radius:10px;border:1px solid #c7c7cc;font-size:1rem;box-sizing:border-box;background:#fff;
  }
  textarea{min-height:90px;resize:vertical;}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.06);margin-right:8px;}
  .list{display:grid;gap:10px;}
  .list .item{background:var(--card);border-radius:12px;box-shadow:var(--shadow);padding:12px;}
  .empty{padding:16px;border:1px dashed #ccc;border-radius:12px;text-align:center;color:#777;}
  .footerbar{position:sticky;bottom:0;background:rgba(245,245,247,.9);backdrop-filter:blur(6px);padding:10px;border-top:1px solid #e5e5ea;margin-top:14px;}
  .kpi{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px;}
  canvas{width:100%;max-width:700px;height:160px;display:block;margin-top:6px;}
  @media (max-width:680px){ body{padding:12px} button{padding:10px 12px;font-size:.95rem} .grid-2{grid-template-columns:1fr;} }
  body.dark{--bg:#0b0b0c;--fg:#e6e6e8;--card:#161617;--muted:#a1a1a6;--accent:#0a84ff;--shadow:0 6px 18px rgba(0,0,0,0.25)}
</style>
</head>
<body>
  <div class="topbar">
    <h1>Routine Mattutina â€” Diario</h1>
    <div class="row">
      <button class="secondary" id="toggleThemeBtn" title="Tema">ðŸŒ™</button>
      <button class="secondary" id="goHomeBtn">Home</button>
    </div>
  </div>

  <!-- HOME -->
  <div id="home" class="screen active">
    <div class="card">
      <p class="muted small">Registra i dati a fine giornata. Puoi poi <strong>esportare un JSON</strong> da inviarmi.</p>
      <div class="row" style="gap:10px">
        <button id="toRecordBtn">Registra giornata</button>
        <button id="toTrendsBtn" class="secondary">Vedi andamento</button>
        <button id="toInfoBtn" class="secondary">Info</button>
        <button id="exportBtn" class="secondary">Esporta JSON</button>
        <button id="clearBtn" class="secondary" title="Cancella dati locali">Pulisci tutto</button>
      </div>
    </div>
    <div class="card" style="margin-top:10px;">
      <div><span class="pill">Oggi:</span> <span id="todayLabel"></span></div>
      <div class="kpi" id="homeKpis"></div>
    </div>
  </div>

  <!-- RECORD -->
  <div id="record" class="screen">
    <h2>Registra giornata</h2>
    <div class="card">
      <div class="grid-2">
        <div>
          <label for="date">Data</label>
          <input id="date" type="date"/>
        </div>
        <div>
          <label for="colazione_tipo">Colazione â€” tipo</label>
          <select id="colazione_tipo">
            <option value="">Selezionaâ€¦</option>
            <option>proteica</option>
            <option>mista</option>
            <option>dolce</option>
          </select>
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label for="ore_sonno">Ore di sonno (h.decimali)</label>
          <input id="ore_sonno" type="number" step="0.1" min="0" max="14" placeholder="es. 7.5"/>
        </div>
        <div>
          <label for="qualita_sonno">QualitÃ  sonno (0â€“10)</label>
          <input id="qualita_sonno" type="number" step="1" min="0" max="10"/>
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label for="caffeina_qta">Caffeina â€” quantitÃ  (nÂ° caffÃ¨)</label>
          <input id="caffeina_qta" type="number" step="1" min="0" max="10"/>
        </div>
        <div>
          <label for="caffeina_orario">Caffeina â€” orario principale</label>
          <input id="caffeina_orario" type="time"/>
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label for="focus_mattina">Focus mattina (0â€“10)</label>
          <input id="focus_mattina" type="number" step="1" min="0" max="10"/>
        </div>
        <div>
          <label for="focus_pomeriggio">Focus pomeriggio (0â€“10)</label>
          <input id="focus_pomeriggio" type="number" step="1" min="0" max="10"/>
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label for="energia">Energia complessiva (0â€“10)</label>
          <input id="energia" type="number" step="1" min="0" max="10"/>
        </div>
        <div>
          <label for="umore">Umore (âˆ’3 â€¦ +3)</label>
          <input id="umore" type="number" step="1" min="-3" max="3"/>
        </div>
      </div>

      <div>
        <label for="stress">Stress (0â€“10)</label>
        <input id="stress" type="number" step="1" min="0" max="10"/>
      </div>

      <div>
        <label for="note">Note libere</label>
        <textarea id="note" placeholder="Eventi, distrazioni, variazioni di routineâ€¦"></textarea>
      </div>

      <div class="row" style="margin-top:8px">
        <button id="saveBtn">Salva giornata</button>
        <button class="secondary" id="backHome1">Annulla</button>
      </div>
    </div>
    <div class="footerbar muted small">I dati vengono salvati solo sul tuo dispositivo (Local Storage).</div>
  </div>

  <!-- TRENDS -->
  <div id="trends" class="screen">
    <h2>Andamento</h2>
    <div id="trendList" class="list"></div>
    <div class="card">
      <h3 class="small muted" style="margin:0 0 6px">Grafici rapidi</h3>
      <canvas id="chartFocus"></canvas>
      <canvas id="chartEnergia"></canvas>
      <canvas id="chartSonno"></canvas>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="backHome2" class="secondary">Torna alla Home</button>
    </div>
  </div>

  <!-- INFO -->
  <div id="info" class="screen">
    <h2>Info â€” Cosa fare al mattino</h2>
    <div class="card">
      <ol style="margin:0;padding-left:18px;">
        <li><strong>Appena sveglio</strong>: acqua (250â€“300 ml), luce naturale 5â€“10â€², movimento leggero 5â€“10â€².</li>
        <li><strong>Doccia</strong>: tiepida con finale freddo 30â€“60â€³ per attivazione.</li>
        <li><strong>Colazione</strong> (dopo 20â€“30â€²): proteine + grassi buoni + carbo complessi. Evita zuccheri rapidi.</li>
        <li><strong>CaffÃ¨</strong>: 60â€“90â€² dopo il risveglio, 1â€“2 tazze max, non a digiuno.</li>
        <li><strong>Deep work</strong>: prima sessione 09:00â€“11:00 senza notifiche; poi pausa luce/movimento.</li>
        <li><strong>Pomeriggio</strong>: consolidamento/recall (flashcard, spiegare a voce).</li>
        <li><strong>Sera</strong>: routine tranquilla, schermi ridotti, sonno 23:30â€“00:00.</li>
        <li><strong>Sabato</strong>: giorno libero (nessuna registrazione), valuta lâ€™effetto la domenica.</li>
      </ol>
      <p class="muted small" style="margin-top:8px;">Obiettivo: dopamina tonica stabile, glicemia regolare, attenzione sostenuta.</p>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="backHome3" class="secondary">Torna alla Home</button>
    </div>
  </div>

<script>
/* ====== Storage helpers ====== */
const LS_KEY = "routine_diario_entries_v1";
function lsGet(){ try{ const v=localStorage.getItem(LS_KEY); return v? JSON.parse(v): []; } catch(e){ return []; } }
function lsSet(arr){ try{ localStorage.setItem(LS_KEY, JSON.stringify(arr)); } catch(e){} }

/* ====== Navigation ====== */
const screens = {home:document.getElementById('home'), record:document.getElementById('record'), trends:document.getElementById('trends'), info:document.getElementById('info')};
function show(id){ Object.values(screens).forEach(s=>s.classList.remove('active')); (screens[id]||screens.home).classList.add('active'); if(id==='trends'){ renderTrends(); drawCharts(); } if(id==='home'){ renderHomeKpis(); } }
document.getElementById('goHomeBtn').onclick=()=>show('home');
document.getElementById('toRecordBtn').onclick=()=>show('record');
document.getElementById('toTrendsBtn').onclick=()=>show('trends');
document.getElementById('toInfoBtn').onclick=()=>show('info');
document.getElementById('backHome1').onclick=()=>show('home');
document.getElementById('backHome2').onclick=()=>show('home');
document.getElementById('backHome3').onclick=()=>show('home');

/* ====== Theme ====== */
const themeBtn = document.getElementById('toggleThemeBtn');
const savedTheme = localStorage.getItem('theme_pref');
if(savedTheme==='dark'){ document.body.classList.add('dark'); themeBtn.textContent='â˜€ï¸'; }
themeBtn.onclick = ()=>{ document.body.classList.toggle('dark'); const dark=document.body.classList.contains('dark'); themeBtn.textContent= dark? 'â˜€ï¸':'ðŸŒ™'; localStorage.setItem('theme_pref', dark?'dark':'light'); };

/* ====== Today label ====== */
document.getElementById('todayLabel').textContent = new Date().toLocaleDateString('it-IT', {weekday:'long', year:'numeric', month:'long', day:'numeric'});

/* ====== Record screen defaults ====== */
const dateInput = document.getElementById('date');
dateInput.valueAsDate = new Date();
document.getElementById('saveBtn').onclick = saveEntry;

/* ====== Save ====== */
function saveEntry(){
  const entry = {
    date: dateInput.value || new Date().toISOString().slice(0,10),
    ore_sonno: parseFloat(document.getElementById('ore_sonno').value||'0'),
    qualita_sonno: toInt(document.getElementById('qualita_sonno').value),
    colazione_tipo: document.getElementById('colazione_tipo').value||'',
    caffeina_qta: toInt(document.getElementById('caffeina_qta').value),
    caffeina_orario: document.getElementById('caffeina_orario').value||'',
    focus_mattina: toInt(document.getElementById('focus_mattina').value),
    focus_pomeriggio: toInt(document.getElementById('focus_pomeriggio').value),
    energia: toInt(document.getElementById('energia').value),
    umore: parseInt(document.getElementById('umore').value||'0'),
    stress: toInt(document.getElementById('stress').value),
    note: (document.getElementById('note').value||'').trim()
  };

  // upsert by date (replace existing entry for same date)
  const all = lsGet();
  const idx = all.findIndex(e => e.date === entry.date);
  if(idx>=0){ all[idx]=entry; } else { all.push(entry); }
  // keep sorted by date ascending
  all.sort((a,b)=> (a.date<b.date?-1:(a.date>b.date?1:0)));
  lsSet(all);
  alert('Giornata salvata!');
  show('home');
  renderHomeKpis();
}

/* Helpers */
function toInt(v){ return v===''||v==null? 0: parseInt(v,10); }

/* ====== Home KPIs ====== */
function renderHomeKpis(){
  const cont = document.getElementById('homeKpis');
  cont.innerHTML='';
  const all = lsGet();
  if(!all.length){ cont.innerHTML='<div class="empty small">Nessun dato registrato ancora.</div>'; return; }
  const last = all[all.length-1];
  const pills = [
    ['Sonno', (last.ore_sonno||0)+' h, qual. '+(last.qualita_sonno||0)+'/10'],
    ['Colazione', last.colazione_tipo||'â€”'],
    ['Caffeina', (last.caffeina_qta||0)+' tazze'+(last.caffeina_orario?(' @ '+last.caffeina_orario):'')],
    ['Focus', (last.focus_mattina||0)+' / '+(last.focus_pomeriggio||0)],
    ['Energia', (last.energia||0)+'/10'],
    ['Umore', (last.umore>=0?'+':'')+(last.umore||0)],
    ['Stress', (last.stress||0)+'/10']
  ];
  pills.forEach(p=>{
    const el=document.createElement('div');
    el.className='pill'; el.textContent = p[0]+': '+p[1];
    cont.appendChild(el);
  });
}

/* ====== Trends list ====== */
function renderTrends(){
  const wrap = document.getElementById('trendList');
  const all = lsGet();
  wrap.innerHTML='';
  if(!all.length){ wrap.innerHTML='<div class="empty">Ancora nessun dato registrato.</div>'; return; }
  all.forEach(e=>{
    const item = document.createElement('div');
    item.className='item';
    item.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
        <div><strong>${formatDate(e.date)}</strong></div>
        <div class="muted small">Colazione: <strong>${e.colazione_tipo||'â€”'}</strong> â€¢ CaffÃ¨: <strong>${e.caffeina_qta||0}</strong>${e.caffeina_orario?(' @ '+e.caffeina_orario):''}</div>
      </div>
      <div class="kpi">
        <span class="pill">Sonno: ${e.ore_sonno||0}h (qual. ${e.qualita_sonno||0}/10)</span>
        <span class="pill">Focus: ${e.focus_mattina||0}/${e.focus_pomeriggio||0}</span>
        <span class="pill">Energia: ${e.energia||0}/10</span>
        <span class="pill">Umore: ${(e.umore>=0?'+':'')+(e.umore||0)}</span>
        <span class="pill">Stress: ${e.stress||0}/10</span>
      </div>
      ${e.note? `<div class="muted small" style="margin-top:6px">${escapeHtml(e.note)}</div>`:''}
    `;
    wrap.appendChild(item);
  });
}
function formatDate(s){ try{ return new Date(s+'T00:00:00').toLocaleDateString('it-IT', {weekday:'short', year:'numeric', month:'short', day:'numeric'}) }catch(_){ return s; } }
function escapeHtml(str){ return str.replace(/[&<>"']/g, m=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }

/* ====== Simple charts (vanilla canvas) ====== */
function drawLine(canvasId, values, label){
  const canvas = document.getElementById(canvasId);
  if(!canvas){return;}
  const ctx = canvas.getContext('2d');
  const W = canvas.width = canvas.clientWidth;
  const H = canvas.height = 160;
  ctx.clearRect(0,0,W,H);
  ctx.lineWidth = 2;
  ctx.lineJoin = 'round';
  ctx.lineCap = 'round';

  // Axes
  ctx.strokeStyle = 'rgba(0,0,0,0.15)';
  ctx.beginPath();
  ctx.moveTo(30,10); ctx.lineTo(30,H-25); ctx.lineTo(W-10,H-25); ctx.stroke();

  if(!values.length){ ctx.fillStyle='#777'; ctx.fillText('Nessun dato', W/2-40, H/2); return; }

  const min = Math.min(...values);
  const max = Math.max(...values);
  const pad = (max - min) * 0.2 || 1;
  const lo = min - pad, hi = max + pad;

  function x(i){ return 30 + (i*(W-40))/Math.max(1,values.length-1); }
  function y(v){ const t = (v - lo)/(hi - lo); return (H-25) - t*(H-40); }

  // grid
  ctx.strokeStyle = 'rgba(0,0,0,0.07)';
  ctx.setLineDash([3,3]);
  ctx.beginPath();
  for(let g=0; g<5; g++){ const gy = 20 + g*((H-45)/4); ctx.moveTo(30,gy); ctx.lineTo(W-10,gy); }
  ctx.stroke(); ctx.setLineDash([]);

  // line
  ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue('--accent').trim() || '#0a84ff';
  ctx.beginPath();
  ctx.moveTo(x(0), y(values[0]));
  for(let i=1;i<values.length;i++){ ctx.lineTo(x(i), y(values[i])); }
  ctx.stroke();

  // label
  ctx.fillStyle = getComputedStyle(document.body).color;
  ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
  ctx.fillText(label, 36, 16);
}

function drawCharts(){
  const all = lsGet();
  const focus = all.map(e => ((e.focus_mattina||0) + (e.focus_pomeriggio||0))/2);
  const energia = all.map(e => (e.energia||0));
  const sonno = all.map(e => (e.ore_sonno||0));
  drawLine('chartFocus', focus, 'Focus medio');
  drawLine('chartEnergia', energia, 'Energia');
  drawLine('chartSonno', sonno, 'Ore di sonno');
}

/* ====== Export / Clear ====== */
document.getElementById('exportBtn').onclick = ()=>{
  const data = lsGet();
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'routine_diario_export.json';
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 500);
};
document.getElementById('clearBtn').onclick = ()=>{
  if(confirm('Vuoi eliminare TUTTI i dati locali?')){ localStorage.removeItem(LS_KEY); alert('Dati rimossi.'); renderHomeKpis(); }
};

/* ====== Init ====== */
renderHomeKpis();

</script>
</body>
</html>
